<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBM CRM - Dual Upload Interface</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .header { text-align: center; margin-bottom: 30px; }
        .upload-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .upload-box { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
            transition: border-color 0.3s;
        }
        .upload-box:hover { border-color: #007bff; }
        .upload-box.dragover { border-color: #28a745; background: #f8fff9; }
        
        .dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }
        .dropzone:hover { border-color: #007bff; background: #f8f9fa; }
        .dropzone.dragover { border-color: #28a745; background: #e8f5e9; }
        
        .file-input { display: none; }
        .btn { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        
        .format-info { 
            background: #e9ecef; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
            font-size: 12px;
        }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 5px; 
            display: none;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        .file-list { margin: 10px 0; }
        .file-item { 
            background: #f8f9fa; 
            padding: 8px 12px; 
            margin: 5px 0; 
            border-radius: 4px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s;
        }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 11px; }
        .auth-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🏢 SBM AI CRM System</h1>
        <h2>📂 Dual Upload Interface</h2>
        <p>Upload customer data in two different formats with automatic processing</p>
    </div>

    <div class="auth-section">
        <h3>🔐 Authentication</h3>
        <input type="text" id="username" placeholder="Username" value="admin" style="margin: 5px; padding: 8px;">
        <input type="password" id="password" placeholder="Password" value="admin123" style="margin: 5px; padding: 8px;">
        <button class="btn btn-primary" onclick="login()">🔑 Login</button>
        <button class="btn btn-secondary" onclick="logout()">🚪 Logout</button>
        <div id="authStatus" style="margin-top: 10px;"></div>
    </div>

    <div class="upload-container">
        <!-- Chinese Format Upload -->
        <div class="upload-box">
            <h3>🇨🇳 Chinese Format Upload</h3>
            <div class="format-info">
                <strong>Expected columns:</strong><br>
                会员id, 所在地, 性别, 生日, 注册时间, <strong style="color: #007bff;">消费时间</strong>, 会员等级, 消费金额, 消费获取积分, 消费业态, 消费店铺
                <br><br>
                <strong>Column Details:</strong><br>
                • 会员id: Customer ID<br>
                • 所在地: Location/Region<br>
                • 性别: Gender<br>
                • 生日: Birthday<br>
                • 注册时间: Registration time<br>
                • <strong style="color: #007bff;">消费时间: Purchase/consumption time</strong><br>
                • 会员等级: Membership level (橙卡会员, 金卡会员, 钻卡会员)<br>
                • 消费金额: Purchase amount<br>
                • 消费获取积分: Points earned<br>
                • 消费业态: Business type<br>
                • 消费店铺: Store name
            </div>
            
            <div class="dropzone" id="dropzone1" onclick="document.getElementById('fileInput1').click()">
                <div>📁 Drop CSV/Excel file here or click to browse</div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    Supports: .csv, .xlsx files<br>
                    Includes purchase data and membership levels
                </div>
            </div>
            
            <input type="file" id="fileInput1" class="file-input" accept=".csv,.xlsx" multiple>
            <div id="fileList1" class="file-list"></div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" onclick="uploadFiles('chinese', 1)">
                    🚀 Upload Chinese Format
                </button>
                <label style="margin-left: 10px;">
                    <input type="checkbox" id="autoSegment1" checked> Auto-segment customers
                </label>
            </div>
            
            <div id="result1" class="result"></div>
        </div>

        <!-- Mixed Format Upload -->
        <div class="upload-box">
            <h3>🔄 Mixed Format Upload</h3>
            <div class="format-info">
                <strong>Expected columns:</strong><br>
                id, member_name, sex, birthday, rating_id, from_org_id, reg_date, expanding_type_name, expanding_channel_name, 注册项目, 年龄, 生日月, 出生身份
                <br><br>
                <strong>Note:</strong> Records with sex="privacy" will be automatically filtered out
            </div>
            
            <div class="dropzone" id="dropzone2" onclick="document.getElementById('fileInput2').click()">
                <div>📁 Drop CSV/Excel file here or click to browse</div>
                <div style="font-size: 12px; color: #666; margin-top: 10px;">
                    Supports: .csv, .xlsx files<br>
                    Auto-filters privacy records
                </div>
            </div>
            
            <input type="file" id="fileInput2" class="file-input" accept=".csv,.xlsx" multiple>
            <div id="fileList2" class="file-list"></div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" onclick="uploadFiles('mixed', 2)">
                    🚀 Upload Mixed Format
                </button>
                <label style="margin-left: 10px;">
                    <input type="checkbox" id="autoSegment2" checked> Auto-segment customers
                </label>
            </div>
            
            <div id="result2" class="result"></div>
        </div>
    </div>

    <div class="stats-grid" id="statsGrid" style="display: none;">
        <div class="stat-card">
            <div class="stat-number" id="totalCustomers">0</div>
            <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalPurchases">0</div>
            <div class="stat-label">Total Purchases</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="recentUploads">0</div>
            <div class="stat-label">Recent Uploads</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="dataQuality">0%</div>
            <div class="stat-label">Data Quality</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let authToken = localStorage.getItem('access_token');

        // Initialize drag and drop
        function initDragAndDrop() {
            [1, 2].forEach(num => {
                const dropzone = document.getElementById(`dropzone${num}`);
                const fileInput = document.getElementById(`fileInput${num}`);

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'), false);
                });

                dropzone.addEventListener('drop', (e) => handleDrop(e, num), false);
                fileInput.addEventListener('change', (e) => handleFileSelect(e, num), false);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e, boxNum) {
            const dt = e.dataTransfer;
            const files = dt.files;
            updateFileList(files, boxNum);
        }

        function handleFileSelect(e, boxNum) {
            updateFileList(e.target.files, boxNum);
        }

        function updateFileList(files, boxNum) {
            const fileList = document.getElementById(`fileList${boxNum}`);
            fileList.innerHTML = '';

            Array.from(files).forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>📄 ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button onclick="removeFile(${boxNum}, ${index})" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer;">×</button>
                `;
                fileList.appendChild(fileItem);
            });

            // Store files in a global variable for upload
            window[`selectedFiles${boxNum}`] = files;
        }

        function removeFile(boxNum, index) {
            const files = window[`selectedFiles${boxNum}`];
            const newFiles = Array.from(files).filter((_, i) => i !== index);
            
            // Create a new FileList-like object
            const dt = new DataTransfer();
            newFiles.forEach(file => dt.items.add(file));
            
            document.getElementById(`fileInput${boxNum}`).files = dt.files;
            updateFileList(dt.files, boxNum);
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('access_token', authToken);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    
                    document.getElementById('authStatus').innerHTML = 
                        `<span style="color: green;">✅ Logged in as ${data.user_info.username}</span>`;
                    
                    await loadStats();
                } else {
                    document.getElementById('authStatus').innerHTML = 
                        `<span style="color: red;">❌ ${data.error?.message || 'Login failed'}</span>`;
                }
            } catch (error) {
                document.getElementById('authStatus').innerHTML = 
                    `<span style="color: red;">❌ Error: ${error.message}</span>`;
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            document.getElementById('authStatus').innerHTML = 
                `<span style="color: #666;">🚪 Logged out</span>`;
            document.getElementById('statsGrid').style.display = 'none';
        }

        async function uploadFiles(format, boxNum) {
            const files = window[`selectedFiles${boxNum}`];
            const autoSegment = document.getElementById(`autoSegment${boxNum}`).checked;
            const resultDiv = document.getElementById(`result${boxNum}`);

            if (!files || files.length === 0) {
                showResult(boxNum, 'error', 'Please select files to upload');
                return;
            }

            if (!authToken) {
                showResult(boxNum, 'error', 'Please login first');
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await uploadSingleFile(file, format, boxNum, autoSegment, i + 1, files.length);
            }

            // Refresh stats after upload
            await loadStats();
        }

        async function uploadSingleFile(file, format, boxNum, autoSegment, fileIndex, totalFiles) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('auto_segment', autoSegment);

            const endpoint = format === 'chinese' ? 'upload/chinese' : 'upload/mixed';
            
            showResult(boxNum, 'loading', `Uploading file ${fileIndex}/${totalFiles}: ${file.name}...`);

            try {
                const response = await fetch(`${API_BASE}/api/customers/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-Refresh-Token': localStorage.getItem('refresh_token')
                    },
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const summary = data.upload_summary;
                    let segmentationInfo = '';
                    
                    if (data.segmentation_results) {
                        const seg = data.segmentation_results;
                        const method = seg.segmentation_method || 'traditional';
                        const isLLM = seg.llm_enabled || false;
                        
                        if (isLLM && method === 'generative_llm') {
                            segmentationInfo = `<br><br>🤖 <strong>AI-Powered Segmentation:</strong><br>
                            • Method: Generative LLM Analysis<br>
                            • Segments created: ${seg.n_clusters}<br>
                            • Algorithm: ${seg.algorithm_used}<br>
                            • Intelligence: Local LLM (Cost-Free)<br>
                            • Quality score: ${seg.silhouette_score.toFixed(3)}<br>
                            • Segment types: ${Object.keys(seg.llm_segments || {}).join(', ')}<br>
                            <small>💡 Segments are intelligently named and contextually analyzed</small>`;
                        } else {
                            segmentationInfo = `<br><br>🎯 <strong>Traditional Segmentation:</strong><br>
                            • Method: ${method}<br>
                            • Clusters created: ${seg.n_clusters}<br>
                            • Algorithm: ${seg.algorithm_used}<br>
                            • Quality score: ${seg.silhouette_score.toFixed(3)}`;
                        }
                        
                        if (seg.error) {
                            segmentationInfo = `<br><br>⚠️ <strong>Segmentation Issues:</strong><br>
                            • Error: ${seg.details}<br>
                            • Fallback applied: ${seg.fallback_applied}`;
                        }
                    }
                    
                    showResult(boxNum, 'success', `
                        <strong>✅ File ${fileIndex}/${totalFiles} uploaded successfully!</strong><br>
                        📊 <strong>Upload Summary:</strong><br>
                        • Format: ${summary.data_format_detected}<br>
                        • Customers saved: ${summary.customers_saved}<br>
                        • Purchases saved: ${summary.purchases_saved || 0}<br>
                        • Duplicates skipped: ${summary.duplicates_skipped}<br>
                        • Data quality: ${summary.data_quality_score.toFixed(1)}%<br>
                        • Processing rate: ${summary.retention_rate.toFixed(1)}%
                        ${segmentationInfo}
                    `);
                } else {
                    showResult(boxNum, 'error', `❌ Upload failed: ${data.error?.message || 'Unknown error'}`);
                }
            } catch (error) {
                showResult(boxNum, 'error', `❌ Network error: ${error.message}`);
            }
        }

        function showResult(boxNum, type, message) {
            const resultDiv = document.getElementById(`result${boxNum}`);
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
        }

        async function loadStats() {
            if (!authToken) return;

            try {
                const response = await fetch(`${API_BASE}/api/customers/insights/real-time`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-Refresh-Token': localStorage.getItem('refresh_token')
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const metrics = data.key_metrics;

                    document.getElementById('totalCustomers').textContent = metrics.total_customers;
                    document.getElementById('totalPurchases').textContent = metrics.total_purchases || 0;
                    document.getElementById('recentUploads').textContent = metrics.new_customers_7d;
                    document.getElementById('dataQuality').textContent = '95%'; // Placeholder

                    document.getElementById('statsGrid').style.display = 'grid';
                }
            } catch (error) {
                console.log('Failed to load stats:', error);
            }
        }

        // Initialize everything
        window.onload = function() {
            initDragAndDrop();
            
            // Check if already logged in
            if (authToken) {
                document.getElementById('authStatus').innerHTML = 
                    `<span style="color: green;">✅ Already logged in</span>`;
                loadStats();
            }
        };
    </script>
</body>
</html>