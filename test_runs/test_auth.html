<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBM CRM - Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; }
        input { margin: 5px; padding: 5px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .token-display { font-family: monospace; word-break: break-all; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üè¢ SBM AI CRM - Authentication Test</h1>
    
    <div class="section info">
        <h3>üîê Test Persistent Authentication</h3>
        <p>This page tests if authentication persists across page refreshes using short JWT tokens and auto-refresh.</p>
        <button onclick="location.reload()">üîÑ Refresh Page</button>
        <button onclick="clearAuth()">üö™ Clear Auth</button>
    </div>

    <div class="section">
        <h3>üìù Login</h3>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="admin123">
        <button onclick="login()">üîë Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="section">
        <h3>üìä Test API Calls</h3>
        <button onclick="testCustomers()">üë• Get Customers</button>
        <button onclick="testInsights()">üí° Get Insights</button>
        <button onclick="testProfile()">üë§ Get Profile</button>
        <div id="apiResult"></div>
    </div>

    <div class="section">
        <h3>üé´ Token Status</h3>
        <div id="tokenStatus"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        // Check auth status on page load
        window.onload = function() {
            updateTokenStatus();
            checkAuthStatus();
        };

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store tokens in localStorage for persistence
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.setItem('user_info', JSON.stringify(data.user_info));
                    
                    document.getElementById('loginResult').innerHTML = 
                        `<div class="success">‚úÖ Logged in as ${data.user_info.username}</div>`;
                    updateTokenStatus();
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        `<div class="error">‚ùå ${data.error?.message || 'Login failed'}</div>`;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function makeAuthenticatedRequest(url, options = {}) {
            let accessToken = localStorage.getItem('access_token');
            
            if (!accessToken) {
                throw new Error('No access token available');
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${accessToken}`,
                    'X-Refresh-Token': localStorage.getItem('refresh_token')
                },
                credentials: 'include'
            });

            // Check if we got a new access token
            const newToken = response.headers.get('X-New-Access-Token');
            if (newToken) {
                localStorage.setItem('access_token', newToken);
                console.log('üîÑ Access token auto-refreshed');
                updateTokenStatus();
            }

            return response;
        }

        async function testCustomers() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/customers/?limit=5`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResult').innerHTML = 
                        `<div class="success">‚úÖ Got ${data.length} customers</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error?.message || 'API call failed');
                }
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function testInsights() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/api/customers/insights/real-time`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResult').innerHTML = 
                        `<div class="success">‚úÖ Real-time insights loaded</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error?.message || 'API call failed');
                }
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function testProfile() {
            try {
                const response = await makeAuthenticatedRequest(`${API_BASE}/auth/me`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResult').innerHTML = 
                        `<div class="success">‚úÖ Profile loaded</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    throw new Error(data.error?.message || 'API call failed');
                }
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        function updateTokenStatus() {
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            const userInfo = localStorage.getItem('user_info');
            
            if (accessToken) {
                const tokenParts = accessToken.split('.');
                const shortToken = `${tokenParts[0].substr(0, 10)}...${tokenParts[2].substr(-10)}`;
                
                document.getElementById('tokenStatus').innerHTML = `
                    <div class="success">
                        <p><strong>üé´ Authenticated</strong></p>
                        <p><strong>User:</strong> ${userInfo ? JSON.parse(userInfo).username : 'Unknown'}</p>
                        <p><strong>Access Token:</strong> <span class="token-display">${shortToken}</span> (${accessToken.length} chars)</p>
                        <p><strong>Refresh Token:</strong> <span class="token-display">${refreshToken ? refreshToken.substr(0, 20) + '...' : 'None'}</span> (${refreshToken?.length || 0} chars)</p>
                        <p><strong>Status:</strong> Ready for API calls</p>
                    </div>
                `;
            } else {
                document.getElementById('tokenStatus').innerHTML = `
                    <div class="error">
                        <p><strong>üö´ Not Authenticated</strong></p>
                        <p>Please log in to test API calls</p>
                    </div>
                `;
            }
        }

        async function checkAuthStatus() {
            const accessToken = localStorage.getItem('access_token');
            if (accessToken) {
                try {
                    await testProfile();
                } catch (error) {
                    console.log('Auth check failed:', error.message);
                }
            }
        }

        function clearAuth() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('apiResult').innerHTML = '';
            updateTokenStatus();
        }
    </script>
</body>
</html>